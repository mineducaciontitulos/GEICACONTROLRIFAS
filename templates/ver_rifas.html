{% extends "base.html" %}
{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">üìã Tus Rifas</h2>
    <div class="d-flex gap-2">
      <a href="{{ url_for('crear_rifa') }}" class="btn btn-success">+ Crear Rifa</a>
      <a href="{{ url_for('panel') }}" class="btn btn-outline-secondary">‚¨ÖÔ∏è Volver al Panel</a>
    </div>
  </div>

  <div class="glass p-3">
    {% if rifas and rifas|length > 0 %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Rifa</th>
            <th class="text-end">Valor N¬∫</th>
            <th class="text-center">Total</th>
            <th class="text-center">Vendidos</th>
            <th style="width:220px">Progreso</th>
            <th>Estado</th>
            <th>Link p√∫blico</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rifas %}
          {% set total = (r["cantidad_numeros"] or 0) %}
          {% set vendidos = (r["vendidos"] or 0) %}
          {% set pct = (vendidos * 100 // total) if total else 0 %}
          <tr>
            <td class="fw-semibold">
              {{ r["nombre"] }}
              <div class="small text-secondary">{{ r["descripcion"] }}</div>
            </td>
            <td class="text-end">$ {{ "{:,}".format(r["valor_numero"]).replace(",", ".") }}</td>
            <td class="text-center">{{ total }}</td>
            <td class="text-center">{{ vendidos }}</td>
            <td>
              <div class="progress" style="height:10px; background:#eef2f7; border-radius:10px; overflow:hidden;">
                <div class="progress-bar"
                     role="progressbar"
                     data-pct="{{ pct }}"
                     aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <div class="small text-secondary mt-1">{{ pct }}%</div>
            </td>
            <td>
              <span class="badge {% if r['estado']=='activa' %}bg-success{% else %}bg-secondary{% endif %}">
                {{ r["estado"]|capitalize }}
              </span>
            </td>
            <td class="small text-truncate" style="max-width:240px;">
              {{ request.host_url.rstrip('/') }}/r/{{ r["link_publico"] }}
            </td>
            <td class="text-end">
              <!-- CAMBIO √öNICO: de btn-group a actions para dar espacio/flujo -->
              <div class="actions">
                <a class="btn btn-info btn-sm" target="_blank"
                   href="{{ url_for('rifa_publica', link_publico=r['link_publico']) }}"
                   aria-label="Abrir rifa p√∫blica">üåê Abrir</a>
                <button type="button" class="btn btn-primary btn-sm btn-copiar"
                        data-url="{{ request.host_url.rstrip('/') }}/r/{{ r['link_publico'] }}"
                        aria-label="Copiar enlace de rifa">üìã Copiar</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="text-secondary">A√∫n no tienes rifas. Crea la primera con el bot√≥n ‚Äú+ Crear Rifa‚Äù.</div>
    {% endif %}
  </div>

</div>

<script>
  // Pintar progreso sin Jinja en CSS
  (function(){
    var bars = document.querySelectorAll('.progress-bar[data-pct]');
    for (var i = 0; i < bars.length; i++) {
      var el = bars[i];
      var pct = parseInt(el.getAttribute('data-pct') || '0', 10);
      if (pct < 0) pct = 0;
      if (pct > 100) pct = 100;
      el.style.width = pct + '%';
      el.style.background = '#22c55e';
      el.style.transition = 'width .3s ease';
    }

    // Copiar link desde data-url
    var copiarBtns = document.querySelectorAll('.btn-copiar[data-url]');
    function copiar(txt){
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(txt).then(function(){ toast('Link copiado ‚úÖ'); })
          .catch(function(){ toast('No se pudo copiar'); });
      } else {
        var ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); toast('Link copiado ‚úÖ'); }
        catch(e){ toast('No se pudo copiar'); }
        finally { ta.remove(); }
      }
    }
    for (var j = 0; j < copiarBtns.length; j++) {
      copiarBtns[j].addEventListener('click', function(){
        var url = this.getAttribute('data-url');
        if (url) copiar(url);
      });
    }

    function toast(msg){
      var b = document.createElement('div');
      b.textContent = msg;
      b.style.position='fixed';
      b.style.right='16px';
      b.style.bottom='16px';
      b.style.background='#111827';
      b.style.color='#fff';
      b.style.padding='10px 14px';
      b.style.borderRadius='10px';
      b.style.boxShadow='0 10px 20px rgba(0,0,0,.2)';
      b.style.zIndex='9999';
      document.body.appendChild(b);
      setTimeout(function(){ b.remove(); }, 1400);
    }
  })();
</script>
{% endblock %}
