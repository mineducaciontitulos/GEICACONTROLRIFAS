{% extends "base.html" %}
{% block content %}
<div class="container py-4">

  <!-- Encabezado -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h2 class="m-0" style="line-height:1.25;">üëë Panel del Superadmin</h2>
    <a class="btn btn-outline-light" href="{{ url_for('login') }}">‚Üê Ir a Login</a>
  </div>

  <!-- Crear negocio -->
  <div class="glass p-4 mb-4">
    <h5 class="mb-3">‚ûï Crear nuevo negocio</h5>

    <!-- IMPORTANTE: mantenemos el token en la acci√≥n, como ten√≠as -->
    <form method="POST" action="{{ url_for('superadmin_crear_negocio', token=token) }}">
      <div class="row g-3">
        <div class="col-12 col-sm-6 col-lg-4">
          <label class="form-label">Nombre del negocio *</label>
          <input class="form-control" name="nombre_negocio" required placeholder="Barber√≠a Hollywood">
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label">Correo admin *</label>
          <input type="email" class="form-control" name="correo" required placeholder="admin@demo.com">
        </div>

        <div class="col-12 col-sm-6 col-lg-2">
          <label class="form-label">Contrase√±a *</label>
          <input type="password" class="form-control" name="contrasena" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label">Celular (WhatsApp)</label>
          <input class="form-control" name="celular" placeholder="3100000000">
        </div>

        <div class="col-12 col-sm-6 col-lg-4">
          <label class="form-label">Nombre del propietario *</label>
          <input class="form-control" name="nombre_propietario" required placeholder="Juan P√©rez">
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label">Estado</label>
          <select class="form-select" name="estado">
            <option value="activo" selected>Activo</option>
            <option value="inactivo">Inactivo</option>
          </select>
        </div>

        <!-- ===== Wompi ===== -->
        <div class="col-12 col-lg-5">
          <label class="form-label">Wompi Public Key</label>
          <input class="form-control" name="public_key_wompi" placeholder="pub_prod_xxx o pub_test_xxx">
        </div>

        <div class="col-12 col-sm-6 col-lg-5">
          <label class="form-label">Wompi Private Key</label>
          <input class="form-control" name="private_key_wompi" placeholder="prv_prod_xxx o prv_test_xxx">
        </div>

        <div class="col-12 col-sm-6 col-lg-5">
          <label class="form-label">Wompi Integrity Secret</label>
          <input class="form-control" name="integrity_secret_wompi" placeholder="prod_integrity_xxx o test_integrity_xxx">
        </div>

        <div class="col-12 col-lg-7">
          <label class="form-label">Checkout URL (opcional)</label>
          <input class="form-control" name="checkout_url_wompi" placeholder="https://checkout.wompi.co/p/">
        </div>

        <!-- ===== Bot / WhatsApp por negocio (NUEVO) ===== -->
        <div class="col-12 col-md-6">
          <label class="form-label">WhatsApp del negocio (receptor bot)</label>
          <input class="form-control" name="wa_numero_receptor" placeholder="whatsapp:+14155238886">
          <div class="form-text">
            Si cada negocio tendr√° su propio n√∫mero en Twilio, ponlo aqu√≠ para mapear el bot por <code>To</code>.
            Si usar√°s un √∫nico n√∫mero (sandbox), puedes dejarlo vac√≠o.
          </div>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Config del bot (JSON opcional)</label>
          <textarea name="bot_config" class="form-control" rows="3"
            placeholder='{"fallback":"Gracias por escribir. Te respondemos pronto."}'></textarea>
          <div class="form-text">
            Personaliza un mensaje de ayuda/espera por negocio. Debe ser JSON v√°lido (ej: <code>{"fallback":"..."}</code>).
          </div>
        </div>
      </div>

      <div class="d-grid d-md-flex justify-content-md-end mt-3">
        <button class="btn btn-primary px-4">üöÄ Registrar Negocio</button>
      </div>
    </form>
  </div>

  <!-- Tabla de negocios -->
  <div class="glass p-3">
    <h5 class="mb-3">Negocios Registrados</h5>
    <div class="table-responsive">
      <table class="table table-dark table-borderless align-middle mb-0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Celular</th>
            <th>Estado</th>
            <th>Rifas</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for n in negocios %}
          <tr>
            <td>{{ n["id"] }}</td>
            <td class="text-truncate" style="max-width:220px">{{ n["nombre_negocio"] }}</td>
            <td class="text-truncate" style="max-width:240px">{{ n["correo"] }}</td>
            <td class="text-truncate" style="max-width:140px">{{ n["celular"] or '‚Äî' }}</td>
            <td>
              <span class="badge {% if n['estado']=='activo' %}bg-success{% else %}bg-secondary{% endif %}">
                {{ n["estado"]|capitalize }}
              </span>
            </td>
            <td>{{ n["total_rifas"] or 0 }}</td>
            <td class="text-end">
              <form method="POST" action="{{ url_for('superadmin_estado_negocio', token=token) }}" class="d-inline">
                <input type="hidden" name="negocio_id" value="{{ n['id'] }}">
                {% if n["estado"] == "activo" %}
                  <button class="btn btn-sm btn-outline-danger" name="accion" value="desactivar">‚õî Desactivar</button>
                {% else %}
                  <button class="btn btn-sm btn-outline-success" name="accion" value="activar">‚úÖ Activar</button>
                {% endif %}
              </form>
            </td>
          </tr>
          {% endfor %}
          {% if negocios|length == 0 %}
            <tr><td colspan="7" class="text-secondary">No hay negocios registrados.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}