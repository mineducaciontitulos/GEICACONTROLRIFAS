{% extends "base.html" %}

{# ======= META OG/TWITTER para previsualizaci√≥n en WhatsApp/FB/Twitter ======= #}
{% block meta_og %}
  {% set base = (app_base_url or request.host_url).rstrip('/') %}
  {% set og_title = "üéüÔ∏è " ~ rifa["nombre"] ~ " ‚Äî Participa y gana" %}
  {% set og_desc  = (rifa["descripcion"] or ("Rifa organizada por " ~ (negocio["nombre_negocio"] or "GEICACONTROLRIFAS"))) %}
  {% set og_img   = (rifa["imagen_premio"] and (base ~ url_for('static', filename=rifa['imagen_premio']))) 
                    or (base ~ "/static/img/logo-geica.png") %}

  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ og_title }}">
  <meta property="og:description" content="{{ og_desc }}">
  <meta property="og:image" content="{{ og_img }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="{{ base ~ request.path }}">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ og_title }}">
  <meta name="twitter:description" content="{{ og_desc }}">
  <meta name="twitter:image" content="{{ og_img }}">
{% endblock %}

{% block content %}

<style>
  /* ===== Tarjetas / marcos ===== */
  .glass{
    background: rgba(255,255,255,.055);
    border: 2px solid rgba(255,255,255,.12);
    border-radius: 14px;
    box-shadow: 0 10px 28px rgba(0,0,0,.22);
  }

  /* ===== Encabezado ===== */
  .page-header h2{ line-height:1.25 }
  @media (max-width: 576px){
    .page-header .btn{ width:100% }
  }

  /* ===== Talonario: fondo arco√≠ris suave + grid responsive ===== */
  .grid-wrap{
    border-radius: 14px;
    padding: 12px;
    background: linear-gradient(135deg,
                rgba(255,0,150,.10),
                rgba(0,204,255,.10),
                rgba(255,255,0,.10));
  }
  .grid-numeros{
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
    gap: 10px;
  }

  /* ===== Bolas ===== */
  .num-bola{
    display:flex; align-items:center; justify-content:center;
    width:44px; height:44px; border-radius:50%;
    font-weight:700; font-size:.95rem; letter-spacing:.3px;
    border:2px solid transparent; cursor:pointer; user-select:none;
    transition: transform .08s ease, box-shadow .12s ease, background .12s, color .12s, border-color .12s;
  }
  .num-bola.disponible{ background:#fff; color:#111827; border-color:#e5e7eb; }
  .num-bola.disponible:hover{ transform:translateY(-1px); box-shadow:0 8px 16px rgba(0,0,0,.12); }
  .num-bola.reservado{ background:#fff7ed; color:#b45309; border-color:#f59e0b; }
  .num-bola.pagado   { background:#ef4444; color:#fff; border-color:#b91c1c; cursor:not-allowed; opacity:.95; }
  .num-bola.selected { background:#3b82f6; color:#fff; border-color:#1d4ed8; box-shadow:0 0 0 3px rgba(59,130,246,.25); }

  @media (max-width: 480px){
    .grid-numeros{ gap:8px; }
    .num-bola{ width:40px; height:40px; font-size:.9rem; }
  }

  /* ===== Imagen premio ===== */
  .prize-img{ width:100%; height:auto; border-radius:12px; object-fit:cover; }

  /* ===== Formulario: focus + validaci√≥n verde/rojo ===== */
  .form-control:focus{
    border-color:#3b82f6;
    box-shadow: 0 0 0 .25rem rgba(59,130,246,.25);
  }
  .form-control.is-valid{
    border-color:#198754 !important;
    box-shadow: 0 0 0 .25rem rgba(25,135,84,.25);
    background-image:none !important;
  }
  .form-control.is-invalid{
    border-color:#dc3545 !important;
    box-shadow: 0 0 0 .25rem rgba(220,53,69,.25);
    background-image:none !important;
  }

  /* ===== Pie de totales ===== */
  .totales{
    font-weight:600;
  }
</style>

<div class="container py-4">
  <!-- Header -->
  <div class="page-header d-flex justify-content-between align-items-center gap-2 mb-3 flex-wrap">
    <h2 class="m-0">üéüÔ∏è {{ rifa["nombre"] }}</h2>
    <a href="{{ url_for('panel') }}" class="btn btn-outline-secondary d-none d-md-inline">‚¨ÖÔ∏è Panel</a>
  </div>

  <div class="row g-4 align-items-start">
    <!-- Columna izquierda: detalle -->
    <div class="col-12 col-lg-5">
      <div class="glass p-3">
        {% if rifa["imagen_premio"] %}
          <img src="{{ url_for('static', filename=rifa['imagen_premio']) }}" alt="Premio" class="prize-img mb-3">
        {% endif %}

        <div class="mb-2">
          <div class="text-secondary small">Precio por n√∫mero</div>
          <div class="h4 m-0">$ {{ "{:,}".format(rifa["valor_numero"]).replace(",", ".") }} COP</div>
        </div>

        {% if negocio %}
          <div class="small text-secondary">
            Organiza: <strong>{{ negocio["nombre_negocio"] }}</strong>
          </div>
        {% endif %}

        {% if rifa["descripcion"] %}
          <hr class="my-3">
          <p class="m-0">{{ rifa["descripcion"] }}</p>
        {% endif %}

        {# ===== Bot√≥n WhatsApp al BOT =====
           Solo se muestra si 'wa_link' viene del backend.
           All√≠ ya filtramos que NO sea el n√∫mero de soporte, para que no haya confusi√≥n. #}
        {% if wa_link %}
          <a class="btn btn-success w-100 mt-3" href="{{ wa_link }}" target="_blank" rel="noopener">
            üí¨ WhatsApp (atenci√≥n autom√°tica)
          </a>
          <div class="form-text mt-1">
            Te atiende el asistente del negocio. Si necesitas hablar con el organizador, √©l podr√° responderte desde all√≠.
          </div>
        {% endif %}
      </div>

      <!-- Leyenda -->
      <div class="glass p-3 mt-3">
        <div class="d-flex flex-wrap gap-3 small">
          <div class="d-flex align-items-center gap-2">
            <span class="num-bola disponible" style="width:26px;height:26px;border-width:2px;"></span> Disponible
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="num-bola reservado" style="width:26px;height:26px;border-width:2px;"></span> Reservado
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="num-bola pagado" style="width:26px;height:26px;border-width:2px;"></span> Pagado
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="num-bola selected" style="width:26px;height:26px;border-width:2px;"></span> Seleccionado
          </div>
        </div>
      </div>
    </div>

    <!-- Columna derecha: talonario + pago -->
    <div class="col-12 col-lg-7">
      <!-- Talonario -->
      <div class="glass p-3 mb-3">
        <h5 class="mb-3">Elige tus n√∫meros</h5>
        <div class="grid-wrap">
          <div class="grid-numeros" id="grid-numeros" data-precio="{{ rifa['valor_numero']|int }}">
            {% for n in numeros %}
              <button
                type="button"
                class="num-bola {{ n.estado }}"
                data-numero="{{ n.numero }}"
                {% if n.estado == 'pagado' %}disabled{% endif %}
              >{{ n.numero }}</button>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Datos comprador -->
      <div class="glass p-3">
        <h5 class="mb-3">Tus datos</h5>
        <form id="form-pago" class="row g-3" action="{{ url_for('generar_pago') }}">
          <input type="hidden" name="rifa_id" value="{{ rifa['id'] }}">
          <input type="hidden" name="numeros" id="numeros">

          <div class="col-12 col-md-6">
            <label class="form-label">Nombre completo *</label>
            <input class="form-control" name="nombre" required>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">C√©dula *</label>
            <input class="form-control" name="cedula" required inputmode="numeric">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Correo *</label>
            <input type="email" class="form-control" name="correo" required>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Tel√©fono (WhatsApp) *</label>
            <input class="form-control" name="telefono" required inputmode="tel">
          </div>

          <div class="d-flex justify-content-between align-items-center mt-2 flex-wrap gap-2">
            <div class="small text-secondary totales">
              Seleccionados: <strong id="cant">0</strong> ‚Äî Total:
              <strong>$ <span id="total">0</span> COP</strong>
            </div>
            <button type="submit" class="btn btn-primary">üí≥ Pagar con Wompi</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  var grid = document.getElementById('grid-numeros');
  var inputNums = document.getElementById('numeros');
  var cant = document.getElementById('cant');
  var total = document.getElementById('total');

  // Precio desde data-atributo
  var precioUnidad = 0;
  if (grid && grid.dataset && grid.dataset.precio) {
    precioUnidad = parseInt(grid.dataset.precio, 10) || 0;
  }

  if (grid) {
    grid.addEventListener('click', function(e){
      var b = e.target.closest('.num-bola');
      if(!b) return;
      if (b.classList.contains('pagado') || b.classList.contains('reservado')) return;
      b.classList.toggle('selected');

      var sel = Array.prototype.slice.call(
                  grid.querySelectorAll('.num-bola.selected')
                ).map(function(x){ return x.getAttribute('data-numero'); });

      inputNums.value = sel.join(',');
      cant.textContent = String(sel.length);
      total.textContent = (sel.length * precioUnidad).toLocaleString('es-CO');
    });
  }

  var form = document.getElementById('form-pago');
  if (form) {
    form.addEventListener('submit', function(ev){
      ev.preventDefault();
      if(!inputNums.value){
        toast('Selecciona al menos un n√∫mero.');
        return;
      }
      var fd = new FormData(form);
      fetch(form.action, { method: 'POST', body: fd })
        .then(function(r){ return r.json(); })
        .then(function(data){
          if(data && data.ok && data.checkout_url){
            window.location.href = data.checkout_url;
          } else {
            toast((data && data.error) ? data.error : 'No se pudo generar el link de pago.');
          }
        })
        .catch(function(){ toast('Error de conexi√≥n. Intenta de nuevo.'); });
    });
  }

  function toast(msg){
    var b = document.createElement('div');
    b.textContent = msg;
    b.style.position='fixed';
    b.style.right='16px';
    b.style.bottom='16px';
    b.style.background='#111827';
    b.style.color='#fff';
    b.style.padding='10px 14px';
    b.style.borderRadius='10px';
    b.style.boxShadow='0 10px 20px rgba(0,0,0,.2)';
    b.style.zIndex='9999';
    document.body.appendChild(b);
    setTimeout(function(){ b.remove(); }, 1600);
  }
})();
</script>

{% endblock %}